<div class="page-actions container mt-3 mb-3">
  <a routerLink="/dashboard" class="btn btn--black">â† Dashboard</a>
</div>

<div class="container mt-4">
  <h2 class="fw-semibold text-center mb-4">ğŸ“ Nuevo Asiento Contable</h2>

  <div class="card shadow-sm">
    <div class="card-body">
      <form (ngSubmit)="onSubmit()" #form="ngForm">
        <!-- Fecha y DescripciÃ³n -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label fw-bold">Fecha *</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="entry.date"
              name="date"
              [min]="minDate || ''"
              [max]="maxDate"
              required
            />
            <small class="text-muted" *ngIf="lastEntryDate">
              ğŸ“… Ãšltimo asiento: {{ formatDate(lastEntryDate) }}
            </small>
            <small class="text-muted" *ngIf="!lastEntryDate">
              ğŸ“… No hay asientos previos
            </small>
          </div>
          <div class="col-md-9">
            <label class="form-label fw-bold">DescripciÃ³n *</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="entry.description"
              name="description"
              placeholder="Ej: Venta al contado, Pago de sueldos, etc."
              required
            />
          </div>
        </div>

        <hr />

        <h5 class="mb-3">LÃ­neas del Asiento</h5>

        <!-- Tabla de lÃ­neas -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th style="width: 45%">Cuenta *</th>
                <th style="width: 20%" class="text-end">Debe</th>
                <th style="width: 20%" class="text-end">Haber</th>
                <th style="width: 15%" class="text-center">AcciÃ³n</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of entry.lines; let i = index">
                <td>
                  <select
                    class="form-select"
                    [(ngModel)]="line.accountCode"
                    [name]="'account' + i"
                    required
                  >
                    <option value="">-- Seleccione cuenta --</option>
                    <option *ngFor="let a of imputables" [value]="a.code">
                      {{ a.code }} - {{ a.name }}
                    </option>
                  </select>
                </td>
                <td>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control text-end"
                    [(ngModel)]="line.debit"
                    [name]="'debit' + i"
                    (ngModelChange)="onDebitChange(line)"
                    placeholder="0.00"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control text-end"
                    [(ngModel)]="line.credit"
                    [name]="'credit' + i"
                    (ngModelChange)="onCreditChange(line)"
                    placeholder="0.00"
                  />
                </td>
                <td class="text-center">
                  <button
                    type="button"
                    class="btn btn-sm btn-danger"
                    (click)="removeLine(i)"
                    [disabled]="entry.lines.length <= 1"
                  >
                    ğŸ—‘ï¸ Eliminar
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot class="table-light fw-bold">
              <tr>
                <td class="text-end">Totales:</td>
                <td class="text-end">{{ totalDebit | number: '1.2-2' }}</td>
                <td class="text-end">{{ totalCredit | number: '1.2-2' }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- BotÃ³n para agregar lÃ­nea -->
        <button
          type="button"
          class="btn btn-outline-primary mb-3"
          (click)="addLine()"
        >
          â• Agregar LÃ­nea
        </button>

        <!-- Estado del balance -->
        <div class="alert" [ngClass]="{
          'alert-success': isBalanced(),
          'alert-warning': !isBalanced() && (totalDebit > 0 || totalCredit > 0),
          'alert-secondary': totalDebit === 0 && totalCredit === 0
        }">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold">
              {{ isBalanced() ? 'âœ… Asiento balanceado' : 'âš ï¸ Asiento desbalanceado' }}
            </span>
            <span>
              Diferencia: {{ (totalDebit - totalCredit) | number: '1.2-2' }}
            </span>
          </div>
        </div>

        <!-- Mensajes -->
        <div *ngIf="success" class="alert alert-success">{{ success }}</div>
        <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

        <!-- Botones de acciÃ³n -->
        <div class="text-center mt-4">
          <button
            type="submit"
            class="btn btn-success btn-lg px-5 me-3"
            [disabled]="loading || !form.valid || !isBalanced()"
          >
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            ğŸ’¾ Guardar Asiento
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary btn-lg px-5"
            (click)="cancel()"
            [disabled]="loading"
          >
            âŒ Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ayuda -->
  <div class="alert alert-info mt-4">
    <h6 class="fw-bold">ğŸ’¡ Ayuda:</h6>
    <ul class="mb-0">
      <li><strong>ğŸ“… Fecha:</strong> No se pueden registrar asientos a futuro ni con fecha anterior al Ãºltimo asiento</li>
      <li>Solo se muestran cuentas <strong>imputables</strong> y <strong>activas</strong></li>
      <li>Cada lÃ­nea debe tener monto en <strong>Debe</strong> o en <strong>Haber</strong>, no en ambos</li>
      <li>El total de <strong>Debe</strong> debe ser igual al total de <strong>Haber</strong></li>
      <li>Se requieren al menos <strong>2 lÃ­neas</strong> para crear un asiento</li>
    </ul>
  </div>
</div>
