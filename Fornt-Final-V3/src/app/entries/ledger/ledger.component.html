<div class="page-actions">
  <a routerLink="/dashboard" class="btn btn--black">‚Üê Dashboard</a>
</div>

<div class="container mt-4">
  <h2 class="fw-semibold text-center mb-4">üìò Libro Mayor</h2>

  <!-- üîπ Filtros -->
  <form class="row g-3 mb-4 justify-content-center" (ngSubmit)="loadLedger()">
    <div class="col-md-4">
      <label class="form-label">Cuenta</label>
      <select
        class="form-select"
        [(ngModel)]="selectedAccountCode"
        name="account"
        required
      >
        <option [ngValue]="undefined">Seleccione una cuenta</option>
        <option *ngFor="let a of accounts" [ngValue]="a.code">
          {{ a.code }} - {{ a.name }}
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Desde</label>
      <input type="date" class="form-control" [(ngModel)]="from" name="from" />
    </div>

    <div class="col-md-3">
      <label class="form-label">Hasta</label>
      <input type="date" class="form-control" [(ngModel)]="to" name="to" />
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit" [disabled]="loading">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
  </form>

  <!-- üîπ Spinner -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <!-- üîπ Informaci√≥n de la cuenta -->
  <div *ngIf="!loading && ledgerResponse" class="alert alert-info mb-3">
    <h5 class="mb-2">üìä {{ ledgerResponse.accountCode }} - {{ ledgerResponse.accountName }}</h5>
    <p class="mb-1">
      <strong>Per√≠odo:</strong> {{ ledgerResponse.from | date: 'dd/MM/yyyy' }} - {{ ledgerResponse.to | date: 'dd/MM/yyyy' }}
    </p>
    <p class="mb-0">
      <strong>Saldo de Apertura:</strong>
      <span [class.text-success]="openingBalance >= 0" [class.text-danger]="openingBalance < 0">
        {{ openingBalance | number: '1.2-2' }}
      </span>
    </p>
  </div>

  <!-- üîπ Tabla -->
  <div *ngIf="!loading && ledger && ledger.length > 0" class="table-responsive">
    <table class="table table-striped align-middle shadow-sm">
      <thead class="table-dark">
      <tr>
        <th>Fecha</th>
        <th>Asiento</th>
        <th>Descripci√≥n</th>
        <th class="text-end">D√©bito</th>
        <th class="text-end">Cr√©dito</th>
        <th class="text-end">Saldo</th>
      </tr>
      </thead>

      <tbody>
      <tr *ngFor="let d of ledger; let i = index">
        <td>{{ d.date | date: 'dd/MM/yyyy' }}</td>
        <td>#{{ d.entryId }}</td>
        <td>{{ d.description }}</td>
        <td class="text-end">{{ d.debit || 0 | number: '1.2-2' }}</td>
        <td class="text-end">{{ d.credit || 0 | number: '1.2-2' }}</td>
        <td
          class="text-end fw-semibold"
          [class.text-success]="getPartialBalance(i) >= 0"
          [class.text-danger]="getPartialBalance(i) < 0"
        >
          {{ getPartialBalance(i) | number: '1.2-2' }}
        </td>
      </tr>
      </tbody>

      <tfoot class="fw-bold table-light">
      <tr>
        <td colspan="3" class="text-end">Totales</td>
        <td class="text-end">{{ totalDebit | number: '1.2-2' }}</td>
        <td class="text-end">{{ totalCredit | number: '1.2-2' }}</td>
        <td
          class="text-end"
          [class.text-success]="balance >= 0"
          [class.text-danger]="balance < 0"
        >
          {{ balance | number: '1.2-2' }}
        </td>
      </tr>
      </tfoot>
    </table>
  </div>

  <!-- üîπ Mensajes -->
  <p
    *ngIf="!loading && ledgerResponse && ledger?.length === 0 && !error"
    class="text-center text-muted mt-4"
  >
    No hay movimientos para los filtros seleccionados.
  </p>

  <p *ngIf="error" class="text-danger text-center mt-3">{{ error }}</p>
</div>
